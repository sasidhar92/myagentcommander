<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dwarka Command Center</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #fff;
      --text: #111;
      --border: #e5e5e5;
      --surface: #fafafa;
      --muted: #888;
      --text-light: #666;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.6;
    }

    /* Shared nav */
    .nav { border-bottom: 1px solid #e5e5e5; padding: 16px 0; position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); z-index: 100; }
    .nav__inner { max-width: 1080px; margin: 0 auto; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; }
    .nav__logo { font-size: 1.125rem; font-weight: 700; text-decoration: none; letter-spacing: -0.03em; color: #111; }
    .nav__links { display: flex; gap: 28px; list-style: none; align-items: center; }
    .nav__links a { font-size: 0.875rem; text-decoration: none; color: #555; font-weight: 500; transition: color 0.15s; }
    .nav__links a:hover { color: #111; }
    .nav__links a.active { color: #111; font-weight: 700; }
    .nav__cta { padding: 8px 20px; background: #111; color: #fff !important; border-radius: 6px; font-size: 0.875rem; font-weight: 600; transition: background 0.15s; }
    .nav__cta:hover { background: #333 !important; color: #fff !important; }
    .nav__toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; z-index: 101; }
    .nav__toggle span { display: block; width: 20px; height: 2px; background: #111; margin: 4px 0; transition: 0.3s; }
    @media (max-width: 768px) {
      /* Nav hamburger */
      .nav__toggle { display: block; }
      .nav__inner { position: relative; }
      .nav__links { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; flex-direction: column; padding: 16px 24px; gap: 4px; border-bottom: 1px solid #e5e5e5; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 200; }
      .nav__links.open { display: flex; }
      .nav__links a { font-size: 1rem; padding: 8px 0; }

      /* Break out of 100vh locked layout — switch to normal block flow */
      body { height: auto; overflow-y: auto; display: block; }
      .main-container { display: block; overflow: visible; }
      .main-column { display: block; overflow: visible; }
      .feed-panel { display: block; }

      /* Stats bar: compact single row */
      .stats-bar { flex-wrap: nowrap; justify-content: center; gap: 4px; padding: 6px 8px; font-size: 10px; }
      .stats-bar > span { padding: 2px 6px; }

      /* Sidebar: compact pill strip */
      .sidebar-left { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 8px 12px; max-height: none; overflow-x: auto; overflow-y: hidden; }
      .sidebar-left .section-header { display: none; }
      .sidebar-left #agents-list { display: flex; gap: 6px; flex-wrap: nowrap; }
      .sidebar-left .agent-card { flex-shrink: 0; width: auto; margin-bottom: 0; border: 1px solid var(--border); border-radius: 20px; padding: 6px 12px 6px 6px; display: flex; align-items: center; gap: 8px; }
      .sidebar-left .agent-info { min-width: 0; }
      .sidebar-left .agent-role,
      .sidebar-left .agent-meta,
      .sidebar-left .agent-card svg,
      .sidebar-left .agent-level { display: none; }
      .sidebar-left .agent-name { font-size: 12px; white-space: nowrap; }
      .sidebar-left .agent-name-row { margin-bottom: 0; }
      .sidebar-left .agent-avatar { width: 28px; height: 28px; font-size: 12px; }
      .sidebar-left .agent-status-dot { width: 8px; height: 8px; }

      /* Stage SVG: fill width, scroll horizontally for detail */
      .stage-wrap { overflow-x: auto; overflow-y: hidden; max-height: none; -webkit-overflow-scrolling: touch; }
      .stage-svg { height: auto; width: 700px; min-width: 700px; }

      /* Activity strip */
      .activity-strip { padding: 8px 12px; height: auto; gap: 8px; }

      /* Feed: natural flow */
      .feed-panel { overflow: visible; min-height: 0; }
      .feed-body { overflow: visible; max-height: none; }
      .feed-tabs { overflow-x: auto; }
      .ev-item { padding: 10px 12px; }
      .ev-text { font-size: 12px; }

      /* Mission bar */
      .mission-bar { flex-wrap: wrap; padding: 8px 12px; gap: 8px; }
      .mb-track { max-width: 100%; flex: 1 1 100%; }
    }
    .stats-bar { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px 24px; border-bottom: 1px solid var(--border); font-size: 11px; max-width: 1080px; margin: 0 auto; }
    .stats-bar > span { padding: 3px 10px; border: 1px solid var(--border); border-radius: 12px; color: var(--muted); }
    .stats-bar .val { font-weight: 600; color: var(--text); }
    .stats-bar .status-indicator { display: flex; align-items: center; gap: 6px; }
    .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text); }
    .status-dot.stale { background: #ccc; }
    .status-dot.offline { background: transparent; border: 1.5px solid var(--muted); }

    /* Main container: sidebar + main column */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Agent Sidebar (left, full height) */
    .sidebar-left {
      width: 240px;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 20px 16px;
      flex-shrink: 0;
    }

    /* Main column: stage + strip + feed */
    .main-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* Stage */
    .stage-wrap {
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
    }
    .stage-svg { display: block; width: 100%; height: 280px; }
    .section-header {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px;
      color: var(--muted); margin-bottom: 16px; font-weight: 600;
    }
    .agent-card {
      padding: 12px; border-radius: 10px; margin-bottom: 8px;
      cursor: pointer; transition: background 0.15s; display: flex; gap: 12px;
    }
    .agent-card:hover { background: var(--surface); }
    .agent-avatar-wrapper { position: relative; flex-shrink: 0; }
    .agent-avatar {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--text);
      background: var(--bg); display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: var(--text);
    }
    .agent-status-dot {
      position: absolute; bottom: 0; right: 0; width: 10px; height: 10px;
      border-radius: 50%; border: 2px solid var(--bg);
    }
    .agent-status-dot.idle { background: var(--border); }
    .agent-status-dot.working { background: var(--text); animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
    .agent-info { flex: 1; min-width: 0; }
    .agent-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
    .agent-name { font-size: 13px; font-weight: 700; color: var(--text); }
    .agent-level {
      font-size: 9px; padding: 1px 5px; background: #f0f0f0;
      border-radius: 3px; color: var(--text-light);
    }
    .agent-role { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
    .agent-meta { font-size: 10px; color: var(--text-light); }

    /* Feed Panel */
    .feed-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
    .feed-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .feed-tab {
      font-size: 11px; padding: 10px 16px; border: none; background: transparent;
      color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    .feed-tab:hover { color: var(--text); }
    .feed-tab.active { color: var(--text); border-bottom-color: var(--text); }
    .feed-body { flex: 1; overflow-y: auto; }

    /* Live feed — narrative style */
    .hb-line {
      font-size: 11px; color: var(--muted);
      padding: 8px 16px; border-bottom: 1px solid var(--border);
    }
    .ev-item {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    .ev-item:hover { background: var(--surface); }
    .ev-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .ev-time { font-size: 10px; color: var(--muted); font-variant-numeric: tabular-nums; }
    .ev-agent { font-size: 12px; font-weight: 700; }
    .ev-kind {
      font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;
      padding: 1px 5px; background: #f0f0f0; border-radius: 3px; color: var(--muted);
    }
    .ev-text { font-size: 12px; line-height: 1.5; color: var(--text-light); }
    .ev-group {
      font-size: 11px; color: var(--muted); padding: 8px 16px;
      cursor: pointer; border-bottom: 1px solid var(--border);
    }
    .ev-group:hover { color: var(--text); }
    .ev-group-items { display: none; }
    .ev-group.open .ev-group-items { display: block; }

    /* Tasks */
    .m-card {
      margin: 10px 16px; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; transition: border-color 0.15s;
    }
    .m-card:hover { border-color: #ccc; }
    .m-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .m-title { font-size: 13px; font-weight: 600; }
    .m-badge { font-size: 9px; text-transform: uppercase; padding: 2px 6px; background: #f0f0f0; border-radius: 3px; }
    .m-bar { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 6px; overflow: hidden; }
    .m-bar-fill { height: 100%; background: var(--text); border-radius: 2px; }
    .m-steps { display: flex; flex-wrap: wrap; gap: 4px; }
    .m-step { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: #f0f0f0; }
    .m-step.running { background: #ddd; }
    .m-step.succeeded { background: var(--text); color: #fff; }
    .m-step.failed { text-decoration: line-through; color: var(--muted); }

    /* Social */
    .social-section { padding: 12px 16px; }
    .conv-block { margin-bottom: 20px; }
    .conv-topic { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
    .conv-format {
      font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;
      padding: 2px 6px; background: #f0f0f0; border-radius: 3px; display: inline-block; margin-bottom: 10px;
    }
    .conv-synthesis {
      border: 1px solid var(--border); background: var(--surface); padding: 10px 12px;
      border-radius: 6px; margin-bottom: 12px;
    }
    .conv-synthesis-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 4px; }
    .conv-synthesis-text { font-size: 12px; line-height: 1.5; color: #333; font-style: italic; }
    .round-hdr { font-size: 9px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin: 12px 0 6px; }
    .msg {
      border-left: 1px solid #ddd; padding: 4px 0 8px 12px; margin-bottom: 4px;
    }
    .msg.lead { border-left: 3px solid #111; }
    .msg-name { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
    .msg-text { font-size: 12px; line-height: 1.5; color: #333; white-space: pre-wrap; }

    /* Mission Bar */
    .mission-bar {
      border-top: 1px solid var(--border); padding: 7px 24px;
      display: flex; align-items: center; gap: 16px; flex-shrink: 0; cursor: pointer;
    }
    .mission-bar:hover { background: var(--surface); }
    .mb-label { font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); }
    .mb-count { font-size: 11px; color: var(--muted); }
    .mb-track { flex: 1; max-width: 400px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .mb-fill { height: 100%; background: var(--text); border-radius: 2px; transition: width 0.3s; }
    .mb-stats { font-family: 'SF Mono','Menlo',monospace; font-size: 11px; color: var(--text); }

    .empty { padding: 24px; text-align: center; color: var(--muted); font-size: 12px; }

    /* Activity Strip */
    .activity-strip {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 8px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      height: 48px;
    }
    .strip-center { flex: 1; min-width: 0; }
    .strip-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted);
    }
    .strip-event {
      font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis;
    }
    .strip-time {
      font-size: 10px; color: var(--muted); flex-shrink: 0;
      font-family: 'SF Mono', 'Menlo', monospace;
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #bbb; }
  </style>
</head>
<body>

  <nav class="nav" aria-label="Main navigation">
    <div class="nav__inner">
      <a href="index.html" class="nav__logo">My Agent Commander</a>
      <button class="nav__toggle" aria-label="Menu"><span></span><span></span><span></span></button>
      <ul class="nav__links">
        <li><a href="live-office.html" class="active">Live Office</a></li>
        <li><a href="insights.html">Insights</a></li>
        <li><a href="team.html">Team</a></li>
        <li><a href="index.html#features">Features</a></li>
        <li><a href="index.html#pricing">Pricing</a></li>
        <li><a href="index.html#contact" class="nav__cta">Get Started</a></li>
      </ul>
    </div>
  </nav>
  <div class="stats-bar">
    <span>Agents <span class="val" id="stat-agents">0</span></span>
    <span>Sessions <span class="val" id="stat-sessions">0</span></span>
    <span>Events <span class="val" id="stat-events">0</span></span>
    <span>Insights <span class="val" id="stat-insights">0</span></span>
    <div class="status-indicator">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-label">--</span>
    </div>
  </div>

  <div class="main-container">
    <aside class="sidebar-left">
      <div class="section-header">AGENTS</div>
      <div id="agents-list"></div>
    </aside>
    <div class="main-column">

  <!-- Pixel Art Stage -->
  <div class="stage-wrap">
    <svg class="stage-svg" id="stage-svg" viewBox="0 0 1120 300" preserveAspectRatio="xMidYMid meet">
      <defs>
        <filter id="bubble-shadow" x="-10%" y="-10%" width="120%" height="140%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="1.5" result="blur"/>
          <feOffset in="blur" dx="0" dy="1" result="offset"/>
          <feFlood flood-color="#000" flood-opacity="0.08" result="color"/>
          <feComposite in="color" in2="offset" operator="in" result="shadow"/>
          <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>

      <!-- Floor -->
      <rect width="1120" height="300" fill="#f7f7f7"/>
      <line x1="0" y1="270" x2="600" y2="270" stroke="#eee" stroke-width="1"/>
      <g opacity="0.3">
        <circle cx="80" cy="285" r="1" fill="#ccc"/><circle cx="160" cy="285" r="1" fill="#ccc"/>
        <circle cx="240" cy="285" r="1" fill="#ccc"/><circle cx="320" cy="285" r="1" fill="#ccc"/>
        <circle cx="400" cy="285" r="1" fill="#ccc"/><circle cx="480" cy="285" r="1" fill="#ccc"/>
        <circle cx="560" cy="285" r="1" fill="#ccc"/>
      </g>

      <!-- ═══ ROW 1 DESKS (y=100) ═══ -->

      <!-- Station 1: Narada (cx=120, py=100) -->
      <g id="station-narada">
        <rect x="106" y="108" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="112" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="124" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="92" y="90" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="96" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="140" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="94" y="126" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="108" y="68" width="24" height="18" rx="2" fill="#555" stroke="#444" stroke-width="0.5"/>
        <rect x="110" y="70" width="20" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="118" y="86" width="4" height="4" fill="#999"/>
        <rect x="114" y="90" width="12" height="1" fill="#bbb"/>
        <circle cx="120" cy="100" r="5" fill="#444"/>
        <rect x="115" y="105" width="10" height="8" rx="2" fill="#555"/>
      </g>

      <!-- Station 2: Krishna (cx=300, py=100, lead) -->
      <g id="station-krishna">
        <rect x="286" y="108" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="292" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="304" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="272" y="90" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="276" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="320" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="274" y="126" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="280" y="66" width="22" height="18" rx="2" fill="#333" stroke="#222" stroke-width="0.5"/>
        <rect x="282" y="68" width="18" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="304" y="66" width="22" height="18" rx="2" fill="#333" stroke="#222" stroke-width="0.5"/>
        <rect x="306" y="68" width="18" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="298" y="84" width="4" height="6" fill="#999"/>
        <rect x="294" y="90" width="12" height="1" fill="#bbb"/>
        <circle cx="300" cy="98" r="6" fill="#222"/>
        <rect x="294" y="104" width="12" height="10" rx="2" fill="#333"/>
        <polygon points="297,92 300,89 303,92" fill="#222"/>
      </g>

      <!-- Station 3: Vishwa (cx=480, py=100) -->
      <g id="station-vishwa">
        <rect x="466" y="108" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="472" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="484" y="112" width="4" height="14" fill="#ccc"/>
        <rect x="452" y="90" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="456" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="500" y="96" width="4" height="30" fill="#ccc"/>
        <rect x="454" y="126" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="468" y="68" width="24" height="18" rx="2" fill="#555" stroke="#444" stroke-width="0.5"/>
        <rect x="470" y="70" width="20" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="478" y="86" width="4" height="4" fill="#999"/>
        <rect x="474" y="90" width="12" height="1" fill="#bbb"/>
        <circle cx="480" cy="100" r="5" fill="#444"/>
        <rect x="475" y="105" width="10" height="8" rx="2" fill="#555"/>
      </g>

      <!-- ═══ ROW 2 DESKS (y=210) ═══ -->

      <!-- Station 4: Chanakya (cx=120, py=210) -->
      <g id="station-chanakya">
        <rect x="106" y="218" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="112" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="124" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="92" y="200" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="96" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="140" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="94" y="236" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="108" y="178" width="24" height="18" rx="2" fill="#555" stroke="#444" stroke-width="0.5"/>
        <rect x="110" y="180" width="20" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="118" y="196" width="4" height="4" fill="#999"/>
        <rect x="114" y="200" width="12" height="1" fill="#bbb"/>
        <circle cx="120" cy="210" r="5" fill="#444"/>
        <rect x="115" y="215" width="10" height="8" rx="2" fill="#555"/>
      </g>

      <!-- Station 5: Vidura (cx=300, py=210) -->
      <g id="station-vidura">
        <rect x="286" y="218" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="292" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="304" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="272" y="200" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="276" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="320" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="274" y="236" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="288" y="178" width="24" height="18" rx="2" fill="#555" stroke="#444" stroke-width="0.5"/>
        <rect x="290" y="180" width="20" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="298" y="196" width="4" height="4" fill="#999"/>
        <rect x="294" y="200" width="12" height="1" fill="#bbb"/>
        <circle cx="300" cy="210" r="5" fill="#444"/>
        <rect x="295" y="215" width="10" height="8" rx="2" fill="#555"/>
      </g>

      <!-- Station 6: Hanuman (cx=480, py=210) -->
      <g id="station-hanuman">
        <rect x="466" y="218" width="28" height="4" rx="2" fill="#ddd"/>
        <rect x="472" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="484" y="222" width="4" height="14" fill="#ccc"/>
        <rect x="452" y="200" width="56" height="6" rx="1" fill="#d0d0d0" stroke="#bbb" stroke-width="0.5"/>
        <rect x="456" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="500" y="206" width="4" height="30" fill="#ccc"/>
        <rect x="454" y="236" width="52" height="2" rx="1" fill="#ddd"/>
        <rect x="468" y="178" width="24" height="18" rx="2" fill="#555" stroke="#444" stroke-width="0.5"/>
        <rect x="470" y="180" width="20" height="14" rx="1" fill="#e8e8e8"/>
        <rect x="478" y="196" width="4" height="4" fill="#999"/>
        <rect x="474" y="200" width="12" height="1" fill="#bbb"/>
        <circle cx="480" cy="210" r="5" fill="#444"/>
        <rect x="475" y="215" width="10" height="8" rx="2" fill="#555"/>
      </g>

      <!-- ═══ LOUNGE (x: 660-1100) ═══ -->
      <g id="lounge">
        <!-- Walls with door gap -->
        <line x1="660" y1="50" x2="660" y2="130" stroke="#ddd" stroke-width="1.5"/>
        <line x1="660" y1="180" x2="660" y2="280" stroke="#ddd" stroke-width="1.5"/>
        <line x1="660" y1="50" x2="1100" y2="50" stroke="#ddd" stroke-width="1.5"/>
        <line x1="1100" y1="50" x2="1100" y2="280" stroke="#ddd" stroke-width="1.5"/>
        <line x1="660" y1="280" x2="1100" y2="280" stroke="#ddd" stroke-width="1.5"/>
        <!-- Door frame markers -->
        <line x1="656" y1="130" x2="664" y2="130" stroke="#bbb" stroke-width="1"/>
        <line x1="656" y1="180" x2="664" y2="180" stroke="#bbb" stroke-width="1"/>
        <!-- Label -->
        <text x="880" y="44" font-family="-apple-system, sans-serif" font-size="9" fill="#bbb" text-anchor="middle" letter-spacing="2">LOUNGE</text>

        <!-- Round table -->
        <circle cx="880" cy="155" r="26" fill="none" stroke="#ccc" stroke-width="1.5"/>
        <!-- Chair spots around table -->
        <circle cx="922" cy="155" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>
        <circle cx="901" cy="191" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>
        <circle cx="859" cy="191" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>
        <circle cx="838" cy="155" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>
        <circle cx="859" cy="119" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>
        <circle cx="901" cy="119" r="4" fill="#f0f0f0" stroke="#ddd" stroke-width="0.5"/>

        <!-- Whiteboard -->
        <rect x="720" y="55" width="100" height="40" rx="2" fill="#f5f5f5" stroke="#ccc" stroke-width="0.5"/>
        <rect x="730" y="65" width="40" height="1.5" rx="0.5" fill="#ddd"/>
        <rect x="730" y="72" width="55" height="1.5" rx="0.5" fill="#ddd"/>
        <rect x="730" y="79" width="30" height="1.5" rx="0.5" fill="#ddd"/>

        <!-- Coffee machine -->
        <rect x="1042" y="80" width="16" height="20" rx="2" fill="#bbb"/>
        <rect x="1044" y="74" width="12" height="7" rx="1" fill="#aaa"/>
        <rect x="1046" y="102" width="8" height="4" rx="1" fill="#ccc"/>
        <!-- Steam wisps -->
        <g opacity="0.25">
          <path d="M1049,74 Q1050,70 1048,66" fill="none" stroke="#999" stroke-width="0.8">
            <animate attributeName="d" values="M1049,74 Q1050,70 1048,66;M1049,74 Q1047,69 1050,65;M1049,74 Q1050,70 1048,66" dur="4s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.3;0.5;0.3" dur="4s" repeatCount="indefinite"/>
          </path>
          <path d="M1052,74 Q1053,69 1051,64" fill="none" stroke="#999" stroke-width="0.8">
            <animate attributeName="d" values="M1052,74 Q1053,69 1051,64;M1052,74 Q1050,68 1053,63;M1052,74 Q1053,69 1051,64" dur="4.5s" repeatCount="indefinite" begin="1s"/>
          </path>
        </g>

        <!-- Couch -->
        <rect x="690" y="244" width="60" height="10" rx="3" fill="#ccc"/>
        <rect x="690" y="252" width="60" height="16" rx="4" fill="#ddd"/>

        <!-- Decorative plant -->
        <rect x="1070" y="258" width="6" height="10" rx="1" fill="#bbb"/>
        <ellipse cx="1073" cy="256" rx="6" ry="4" fill="#aaa"/>
      </g>

      <!-- Decorative: plant pots between desks -->
      <rect x="207" y="122" width="6" height="8" rx="1" fill="#bbb"/>
      <ellipse cx="210" cy="120" rx="5" ry="3" fill="#aaa"/>
      <rect x="387" y="122" width="6" height="8" rx="1" fill="#bbb"/>
      <ellipse cx="390" cy="120" rx="5" ry="3" fill="#aaa"/>
      <rect x="207" y="232" width="6" height="8" rx="1" fill="#bbb"/>
      <ellipse cx="210" cy="230" rx="5" ry="3" fill="#aaa"/>
      <rect x="387" y="232" width="6" height="8" rx="1" fill="#bbb"/>
      <ellipse cx="390" cy="230" rx="5" ry="3" fill="#aaa"/>

      <!-- Name labels -->
      <g id="stage-labels" font-family="-apple-system, sans-serif" font-size="9" fill="#888" text-anchor="middle">
        <text x="120" y="138">Narada</text>
        <text x="300" y="138" font-weight="600" fill="#333">Krishna</text>
        <text x="480" y="138">Vishwa</text>
        <text x="120" y="248">Chanakya</text>
        <text x="300" y="248">Vidura</text>
        <text x="480" y="248">Hanuman</text>
      </g>

      <!-- Typing cursors on monitors -->
      <g id="stage-cursors">
        <rect x="112" y="78" width="6" height="1.5" fill="#999" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="1.2s" repeatCount="indefinite" begin="0s"/>
          <animate attributeName="x" values="112;118;114;120;112" dur="4s" repeatCount="indefinite"/>
        </rect>
        <rect x="284" y="74" width="6" height="1.5" fill="#666" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="0.8s" repeatCount="indefinite" begin="0.2s"/>
          <animate attributeName="x" values="284;290;286;292;284" dur="3s" repeatCount="indefinite"/>
        </rect>
        <rect x="308" y="76" width="6" height="1.5" fill="#666" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="1.4s" repeatCount="indefinite" begin="0.5s"/>
        </rect>
        <rect x="472" y="78" width="6" height="1.5" fill="#999" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="0.9s" repeatCount="indefinite" begin="0.3s"/>
          <animate attributeName="x" values="472;478;474;480;472" dur="3.5s" repeatCount="indefinite"/>
        </rect>
        <rect x="112" y="188" width="6" height="1.5" fill="#999" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="1.1s" repeatCount="indefinite" begin="0.7s"/>
          <animate attributeName="x" values="112;118;114;120;112" dur="5s" repeatCount="indefinite"/>
        </rect>
        <rect x="292" y="188" width="6" height="1.5" fill="#999" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="1.3s" repeatCount="indefinite" begin="0.1s"/>
          <animate attributeName="x" values="292;298;294;300;292" dur="4.5s" repeatCount="indefinite"/>
        </rect>
        <rect x="472" y="188" width="6" height="1.5" fill="#999" opacity="0">
          <animate attributeName="opacity" values="0;1;1;0" dur="1.0s" repeatCount="indefinite" begin="0.9s"/>
          <animate attributeName="x" values="472;478;474;480;472" dur="3.8s" repeatCount="indefinite"/>
        </rect>
      </g>

      <!-- Code lines on monitors -->
      <g id="stage-code" opacity="0.4">
        <rect x="110" y="72" width="12" height="1" fill="#aaa">
          <animate attributeName="width" values="12;8;14;10;12" dur="6s" repeatCount="indefinite"/>
        </rect>
        <rect x="110" y="74.5" width="8" height="1" fill="#bbb">
          <animate attributeName="width" values="8;14;6;10;8" dur="7s" repeatCount="indefinite"/>
        </rect>
        <rect x="282" y="70" width="10" height="1" fill="#aaa">
          <animate attributeName="width" values="10;14;8;12;10" dur="4s" repeatCount="indefinite"/>
        </rect>
        <rect x="282" y="72.5" width="14" height="1" fill="#bbb">
          <animate attributeName="width" values="14;8;12;10;14" dur="5s" repeatCount="indefinite"/>
        </rect>
        <rect x="308" y="70" width="8" height="1" fill="#aaa">
          <animate attributeName="width" values="8;12;6;10;8" dur="6.5s" repeatCount="indefinite"/>
        </rect>
        <rect x="472" y="72" width="10" height="1" fill="#aaa">
          <animate attributeName="width" values="10;6;14;8;10" dur="5.5s" repeatCount="indefinite"/>
        </rect>
        <rect x="112" y="182" width="12" height="1" fill="#aaa">
          <animate attributeName="width" values="12;16;8;10;12" dur="7.5s" repeatCount="indefinite"/>
        </rect>
        <rect x="292" y="182" width="10" height="1" fill="#aaa">
          <animate attributeName="width" values="10;14;6;12;10" dur="6s" repeatCount="indefinite" begin="1s"/>
        </rect>
        <rect x="472" y="182" width="8" height="1" fill="#aaa">
          <animate attributeName="width" values="8;12;10;6;8" dur="5s" repeatCount="indefinite" begin="0.5s"/>
        </rect>
      </g>

      <!-- Subtle person body sway -->
      <g id="stage-sway">
        <animateTransform xlink:href="#station-narada" attributeName="transform" type="translate" values="0,0;0.3,-0.3;0,0;-0.3,-0.2;0,0" dur="8s" repeatCount="indefinite"/>
        <animateTransform xlink:href="#station-krishna" attributeName="transform" type="translate" values="0,0;-0.3,-0.4;0,0;0.3,-0.2;0,0" dur="6s" repeatCount="indefinite"/>
        <animateTransform xlink:href="#station-vishwa" attributeName="transform" type="translate" values="0,0;0.2,-0.3;0,0;-0.2,-0.3;0,0" dur="9s" repeatCount="indefinite"/>
        <animateTransform xlink:href="#station-chanakya" attributeName="transform" type="translate" values="0,0;-0.3,-0.2;0,0;0.2,-0.3;0,0" dur="7s" repeatCount="indefinite"/>
        <animateTransform xlink:href="#station-vidura" attributeName="transform" type="translate" values="0,0;0.2,-0.4;0,0;-0.3,-0.2;0,0" dur="10s" repeatCount="indefinite"/>
        <animateTransform xlink:href="#station-hanuman" attributeName="transform" type="translate" values="0,0;-0.2,-0.3;0,0;0.3,-0.4;0,0" dur="8.5s" repeatCount="indefinite"/>
      </g>

      <!-- Floating data particles -->
      <g id="stage-particles" opacity="0.3">
        <!-- Row 1 particles -->
        <circle r="1.5" fill="#999">
          <animate attributeName="cx" values="150;270" dur="3s" repeatCount="indefinite"/>
          <animate attributeName="cy" values="85;80;85" dur="3s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0;0.5;0" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle r="1" fill="#aaa">
          <animate attributeName="cx" values="330;450" dur="4s" repeatCount="indefinite" begin="1s"/>
          <animate attributeName="cy" values="88;82;88" dur="4s" repeatCount="indefinite" begin="1s"/>
          <animate attributeName="opacity" values="0;0.4;0" dur="4s" repeatCount="indefinite" begin="1s"/>
        </circle>
        <!-- Row 2 particles -->
        <circle r="1.5" fill="#999">
          <animate attributeName="cx" values="150;270" dur="3.5s" repeatCount="indefinite" begin="0.5s"/>
          <animate attributeName="cy" values="195;190;195" dur="3.5s" repeatCount="indefinite" begin="0.5s"/>
          <animate attributeName="opacity" values="0;0.5;0" dur="3.5s" repeatCount="indefinite" begin="0.5s"/>
        </circle>
        <circle r="1" fill="#aaa">
          <animate attributeName="cx" values="330;450" dur="4.5s" repeatCount="indefinite" begin="2s"/>
          <animate attributeName="cy" values="198;192;198" dur="4.5s" repeatCount="indefinite" begin="2s"/>
          <animate attributeName="opacity" values="0;0.4;0" dur="4.5s" repeatCount="indefinite" begin="2s"/>
        </circle>
        <!-- Cross-row particles -->
        <circle r="1" fill="#bbb">
          <animate attributeName="cx" values="300;300" dur="3.2s" repeatCount="indefinite" begin="0.8s"/>
          <animate attributeName="cy" values="130;180" dur="3.2s" repeatCount="indefinite" begin="0.8s"/>
          <animate attributeName="opacity" values="0;0.3;0" dur="3.2s" repeatCount="indefinite" begin="0.8s"/>
        </circle>
        <!-- Reverse particles -->
        <circle r="1" fill="#bbb">
          <animate attributeName="cx" values="450;330" dur="4.2s" repeatCount="indefinite" begin="1.2s"/>
          <animate attributeName="cy" values="90;84;90" dur="4.2s" repeatCount="indefinite" begin="1.2s"/>
          <animate attributeName="opacity" values="0;0.3;0" dur="4.2s" repeatCount="indefinite" begin="1.2s"/>
        </circle>
      </g>

      <!-- JS-injected layers -->
      <g id="stage-glow"></g>
      <g id="stage-bubbles"></g>
      <g id="stage-rings"></g>
      <g id="stage-lounge-figures"></g>
    </svg>
  </div>

  <!-- Activity Strip -->
  <div class="activity-strip">
    <div class="strip-center">
      <div class="strip-label">LATEST ACTIVITY</div>
      <div class="strip-event" id="strip-event">--</div>
    </div>
    <div class="strip-time" id="strip-time">--</div>
  </div>

  <!-- Feed Area -->
  <div class="feed-panel">
    <div class="feed-tabs">
      <button class="feed-tab active" data-tab="live">Live Feed</button>
      <button class="feed-tab" data-tab="tasks">Tasks</button>
      <button class="feed-tab" data-tab="social">Social</button>
    </div>
    <div class="feed-body" id="feed-body"></div>
  </div>

  <!-- Mission Bar -->
  <div class="mission-bar" id="mission-bar">
    <span class="mb-label">Missions</span>
    <span class="mb-count" id="mb-count">0 running</span>
    <div class="mb-track"><div class="mb-fill" id="mb-fill" style="width:0%"></div></div>
    <span class="mb-stats" id="mb-stats">--</span>
  </div>

    </div><!-- /main-column -->
  </div><!-- /main-container -->

  <script>
    (function() {
      var data = null;
      var activeTab = 'live';

      var AGENT_POS = {
        narada:   { x: 120, y: 100, row: 1 },
        krishna:  { x: 300, y: 100, row: 1 },
        vishwa:   { x: 480, y: 100, row: 1 },
        chanakya: { x: 120, y: 210, row: 2 },
        vidura:   { x: 300, y: 210, row: 2 },
        hanuman:  { x: 480, y: 210, row: 2 }
      };

      // Clock (element removed from nav; guard to avoid errors)
      function tickClock() {
        var el = document.getElementById('clock');
        if (!el) return;
        var now = new Date();
        el.textContent =
          now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      }
      tickClock();
      setInterval(tickClock, 1000);

      function relTime(iso) {
        if (!iso) return '';
        var d = new Date(iso);
        var diff = Math.floor((new Date() - d) / 1000);
        if (diff < 0) diff = 0;
        if (diff < 60) return 'now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
      }

      function esc(s) {
        if (!s) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      // Clean summary: strip raw JSON, file paths, technical prefixes → human gist
      // Status
      function updateStatus() {
        if (!data) return;
        var dot = document.getElementById('status-dot');
        var label = document.getElementById('status-label');
        var diff = (new Date() - new Date(data.meta.updated_at)) / 60000;
        var ago = relTime(data.meta.updated_at);
        if (data.meta.daemon_status === 'offline') {
          dot.className = 'status-dot offline'; label.textContent = 'Offline';
        } else if (diff < 30) {
          dot.className = 'status-dot'; label.textContent = 'Updated ' + ago;
        } else {
          dot.className = 'status-dot stale'; label.textContent = 'Stale \u00b7 ' + ago;
        }
      }

      function updateStats() {
        if (!data) return;
        document.getElementById('stat-agents').textContent = data.agents ? data.agents.length : 0;
        document.getElementById('stat-sessions').textContent = (data.stats && data.stats.total_sessions) || (data.recent_sessions ? data.recent_sessions.length : 0);
        document.getElementById('stat-events').textContent = (data.stats && data.stats.total_events) || (data.pulse ? data.pulse.length : 0);
        document.getElementById('stat-insights').textContent = data.insights ? data.insights.length : 0;
      }

      // Stage: speech bubbles + status rings
      function updateStage() {
        if (!data) return;
        var bubblesG = document.getElementById('stage-bubbles');
        var ringsG = document.getElementById('stage-rings');
        bubblesG.innerHTML = '';
        ringsG.innerHTML = '';

        data.agents.forEach(function(agent) {
          var pos = AGENT_POS[agent.id];
          if (!pos) return;
          var cx = pos.x;
          var cy = pos.y;

          // Monitor glow for agents with any activity
          if (agent.event_count_24h > 0 || agent.event_count_total > 0 || agent.total_sessions > 0) {
            var screens = document.querySelectorAll('#station-' + agent.id + ' rect[fill="#e8e8e8"]');
            screens.forEach(function(screenEl) {
              if (!screenEl.querySelector('animate')) {
                var glow = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
                glow.setAttribute('attributeName', 'fill');
                glow.setAttribute('values', '#e8e8e8;#d0d0d0;#e8e8e8');
                glow.setAttribute('dur', '3s');
                glow.setAttribute('repeatCount', 'indefinite');
                screenEl.appendChild(glow);
              }
            });
          }

          // Status ring around person
          if (agent.is_active) {
            var personCircle = document.querySelector('#station-' + agent.id + ' circle[fill="#444"]');
            if (personCircle) personCircle.setAttribute('fill', '#111');
            var ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            ring.setAttribute('cx', String(cx));
            ring.setAttribute('cy', String(cy));
            ring.setAttribute('r', '12');
            ring.setAttribute('fill', 'none');
            ring.setAttribute('stroke', '#111');
            ring.setAttribute('stroke-width', '1.5');
            ring.setAttribute('opacity', '0.6');
            var anim = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
            anim.setAttribute('attributeName', 'opacity');
            anim.setAttribute('values', '0.6;0.2;0.6');
            anim.setAttribute('dur', '2s');
            anim.setAttribute('repeatCount', 'indefinite');
            ring.appendChild(anim);
            ringsG.appendChild(ring);
          } else if (agent.event_count_total === 0 && !agent.last_active) {
            var dash = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            dash.setAttribute('cx', String(cx));
            dash.setAttribute('cy', String(cy));
            dash.setAttribute('r', '12');
            dash.setAttribute('fill', 'none');
            dash.setAttribute('stroke', '#ccc');
            dash.setAttribute('stroke-width', '1');
            dash.setAttribute('stroke-dasharray', '3,3');
            ringsG.appendChild(dash);
          }

          // Speech bubble — compact, no overlap, row-aware positioning
          var rawText = agent.last_event_narrative || agent.last_event_summary || '';
          if (agent.name && rawText.toLowerCase().indexOf(agent.name.toLowerCase()) === 0) {
            rawText = rawText.substring(agent.name.length).replace(/^\s+/, '');
            rawText = rawText.charAt(0).toUpperCase() + rawText.slice(1);
          }
          var summary = rawText.substring(0, 40);
          if (!summary) return;
          var bubbleText = summary.length > 22 ? summary.substring(0, 19) + '...' : summary;

          var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.setAttribute('filter', 'url(#bubble-shadow)');

          var tw = Math.min(bubbleText.length * 5.5 + 16, 140);
          var bx = cx - tw / 2;
          var isRow2 = pos.row === 2;
          var bh = 22;

          var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          var tri = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          var cover = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          var txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');

          if (isRow2) {
            // Row 2: bubble BELOW agent, triangle points UP
            var by = cy + 46;
            rect.setAttribute('x', String(bx)); rect.setAttribute('y', String(by));
            rect.setAttribute('width', String(tw)); rect.setAttribute('height', String(bh));
            rect.setAttribute('rx', '6'); rect.setAttribute('fill', '#fff');
            rect.setAttribute('stroke', '#ccc'); rect.setAttribute('stroke-width', '0.5');
            tri.setAttribute('points', (cx - 4) + ',' + by + ' ' + cx + ',' + (by - 6) + ' ' + (cx + 4) + ',' + by);
            tri.setAttribute('fill', '#fff'); tri.setAttribute('stroke', '#ccc'); tri.setAttribute('stroke-width', '0.5');
            cover.setAttribute('x1', String(cx - 5)); cover.setAttribute('y1', String(by));
            cover.setAttribute('x2', String(cx + 5)); cover.setAttribute('y2', String(by));
            cover.setAttribute('stroke', '#fff'); cover.setAttribute('stroke-width', '1');
            txt.setAttribute('x', String(cx)); txt.setAttribute('y', String(by + 15));
          } else {
            // Row 1: bubble ABOVE agent
            var by = cy - 60;
            rect.setAttribute('x', String(bx)); rect.setAttribute('y', String(by));
            rect.setAttribute('width', String(tw)); rect.setAttribute('height', String(bh));
            rect.setAttribute('rx', '6'); rect.setAttribute('fill', '#fff');
            rect.setAttribute('stroke', '#ccc'); rect.setAttribute('stroke-width', '0.5');
            tri.setAttribute('points', (cx - 4) + ',' + (by + bh) + ' ' + cx + ',' + (by + bh + 6) + ' ' + (cx + 4) + ',' + (by + bh));
            tri.setAttribute('fill', '#fff'); tri.setAttribute('stroke', '#ccc'); tri.setAttribute('stroke-width', '0.5');
            cover.setAttribute('x1', String(cx - 5)); cover.setAttribute('y1', String(by + bh));
            cover.setAttribute('x2', String(cx + 5)); cover.setAttribute('y2', String(by + bh));
            cover.setAttribute('stroke', '#fff'); cover.setAttribute('stroke-width', '1');
            txt.setAttribute('x', String(cx)); txt.setAttribute('y', String(by + 15));
          }

          txt.setAttribute('font-size', '9');
          txt.setAttribute('fill', '#333');
          txt.setAttribute('text-anchor', 'middle');
          txt.setAttribute('font-family', '-apple-system, sans-serif');
          txt.textContent = bubbleText;

          g.appendChild(rect);
          g.appendChild(tri);
          g.appendChild(cover);
          g.appendChild(txt);
          bubblesG.appendChild(g);
        });
      }

      // Agent grid
      function renderAgents() {
        if (!data || !data.agents) return;
        var html = '';
        data.agents.forEach(function(a) {
          var initial = a.name.charAt(0).toUpperCase();
          var statusClass = a.is_active ? 'working' : 'idle';
          var sessions = a.total_sessions || 0;
          html += '<div class="agent-card">';
          html += '  <div class="agent-avatar-wrapper">';
          html += '    <div class="agent-avatar">' + esc(initial) + '</div>';
          html += '    <div class="agent-status-dot ' + statusClass + '"></div>';
          html += '  </div>';
          html += '  <div class="agent-info">';
          html += '    <div class="agent-name-row">';
          html += '      <span class="agent-name">' + esc(a.name) + '</span>';
          html += '      <span class="agent-level">' + esc(a.model || 'sonnet') + '</span>';
          html += '    </div>';
          html += '    <div class="agent-role">' + esc(a.role) + '</div>';
          html += '    <div class="agent-meta"><strong style="color:var(--text);font-size:12px">' + sessions + '</strong> sessions</div>';
          if (a.sparkline && a.sparkline.length > 0) {
            var vals = a.sparkline.map(function(s) { return s.count; });
            var maxV = Math.max.apply(null, vals) || 1;
            var sw = 60, sh = 16;
            var pts = vals.map(function(v, i) {
              return Math.round(i * (sw / (vals.length - 1))) + ',' + Math.round(sh - (v / maxV) * (sh - 2) - 1);
            }).join(' ');
            html += '<svg width="' + sw + '" height="' + sh + '" style="display:block;margin-top:4px"><polyline points="' + pts + '" fill="none" stroke="#888" stroke-width="1.5"/></svg>';
          }
          html += '  </div>';
          html += '</div>';
        });
        document.getElementById('agents-list').innerHTML = html;
      }

      // Feed tabs
      document.querySelector('.feed-tabs').addEventListener('click', function(e) {
        var tab = e.target.closest('.feed-tab');
        if (!tab) return;
        document.querySelectorAll('.feed-tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        activeTab = tab.getAttribute('data-tab');
        renderFeed();
      });

      function renderFeed() {
        var c = document.getElementById('feed-body');
        if (activeTab === 'live') renderLive(c);
        else if (activeTab === 'tasks') renderTasks(c);
        else if (activeTab === 'social') renderSocial(c);
      }

      // Live Feed — narrative summaries from data.feed
      function renderLive(c) {
        if (!data || !data.feed || !data.feed.length) {
          c.innerHTML = '<div class="empty">No events yet</div>';
          return;
        }
        var html = '';
        // Show feed in reverse chronological order (newest first)
        var items = data.feed.slice().reverse();

        // Group consecutive same-agent+type runs
        var groups = [];
        var i = 0;
        while (i < items.length) {
          var ev = items[i];
          var run = [ev];
          var j = i + 1;
          while (j < items.length && items[j].agent_id === ev.agent_id && items[j].type === ev.type) {
            run.push(items[j]); j++;
          }
          if (run.length >= 3) {
            groups.push({ grouped: true, events: run });
          } else {
            for (var k = 0; k < run.length; k++) groups.push({ grouped: false, event: run[k] });
          }
          i = j;
        }

        groups.slice(0, 60).forEach(function(g) {
          if (!g.grouped) {
            var e = g.event;
            html += '<div class="ev-item">' +
              '<div class="ev-meta">' +
                '<span class="ev-time">' + relTime(e.timestamp) + '</span>' +
                '<span class="ev-agent">' + esc(e.agent) + '</span>' +
              '</div>' +
              '<div class="ev-text">' + esc(e.narrative) + '</div>' +
            '</div>';
          } else {
            var first = g.events[0];
            html += '<div class="ev-item">' +
              '<div class="ev-meta">' +
                '<span class="ev-time">' + relTime(first.timestamp) + '</span>' +
                '<span class="ev-agent">' + esc(first.agent) + '</span>' +
              '</div>' +
              '<div class="ev-text">' + esc(first.narrative) + '</div>' +
            '</div>';
            html += '<div class="ev-group" onclick="this.classList.toggle(\'open\')">' +
              '\u25BE ' + (g.events.length - 1) + ' more from ' + esc(first.agent) +
              '<div class="ev-group-items">';
            for (var m = 1; m < g.events.length; m++) {
              var ge = g.events[m];
              html += '<div class="ev-item">' +
                '<div class="ev-meta">' +
                  '<span class="ev-time">' + relTime(ge.timestamp) + '</span>' +
                '</div>' +
                '<div class="ev-text">' + esc(ge.narrative) + '</div>' +
              '</div>';
            }
            html += '</div></div>';
          }
        });
        c.innerHTML = html;
      }

      // Tasks
      function renderTasks(c) {
        if (!data || !data.missions_detail || !data.missions_detail.length) {
          c.innerHTML = '<div class="empty">No missions</div>'; return;
        }
        var html = '';
        data.missions_detail.forEach(function(m) {
          var pct = m.progress && m.progress.total > 0
            ? Math.round(m.progress.completed / m.progress.total * 100) : 0;
          html += '<div class="m-card"><div class="m-head">' +
            '<span class="m-title">' + esc(m.title) + '</span>' +
            '<span class="m-badge">' + esc(m.status) + '</span></div>' +
            '<div class="m-bar"><div class="m-bar-fill" style="width:' + pct + '%"></div></div>' +
            '<div class="m-steps">';
          (m.steps || []).forEach(function(s) {
            html += '<span class="m-step ' + esc(s.status) + '">' + esc(s.kind) + '</span>';
          });
          html += '</div></div>';
        });
        c.innerHTML = html;
      }

      // Social — full scrolling, no truncation, filter empty convs
      function renderSocial(c) {
        if (!data || !data.conversations || !data.conversations.length) {
          c.innerHTML = '<div class="empty">No conversations</div>'; return;
        }
        // Filter out conversations with no messages
        var convs = data.conversations.filter(function(conv) {
          return conv.messages && conv.messages.length > 0;
        });
        if (!convs.length) {
          c.innerHTML = '<div class="empty">No conversations with messages</div>'; return;
        }
        var html = '<div class="social-section">';
        convs.forEach(function(conv) {
          html += '<div class="conv-block">' +
            '<div class="conv-topic">' + esc(conv.topic) + '</div>' +
            '<span class="conv-format">' + esc(conv.format) + '</span>';

          if (conv.summary) {
            html += '<div class="conv-synthesis">' +
              '<div class="conv-synthesis-label">Synthesis</div>' +
              '<div class="conv-synthesis-text">' + esc(conv.summary) + '</div></div>';
          }

          // Group by turn
          var rounds = {};
          conv.messages.forEach(function(msg) {
            var t = msg.turn || 1;
            if (!rounds[t]) rounds[t] = [];
            rounds[t].push(msg);
          });

          Object.keys(rounds).sort(function(a, b) { return a - b; }).forEach(function(turn) {
            html += '<div class="round-hdr">Round ' + turn + '</div>';
            rounds[turn].forEach(function(msg) {
              var isLead = msg.agent_id === 'krishna';
              html += '<div class="msg' + (isLead ? ' lead' : '') + '">' +
                '<div class="msg-name">' + esc(msg.agent_name || msg.agent_id) + '</div>' +
                '<div class="msg-text">' + esc(msg.content || '') + '</div>' +
              '</div>';
            });
          });
          html += '</div>';
        });

        html += '</div>';
        c.innerHTML = html;
      }

      // Mission bar
      function updateMissionBar() {
        if (!data || !data.missions_detail) return;
        var running = data.missions_detail.filter(function(m) { return m.status === 'running'; }).length;
        var total = 0, done = 0;
        data.missions_detail.forEach(function(m) {
          if (m.progress) { total += m.progress.total || 0; done += m.progress.completed || 0; }
        });
        var pct = total > 0 ? Math.round(done / total * 100) : 0;
        document.getElementById('mb-count').textContent = running + ' running';
        document.getElementById('mb-fill').style.width = pct + '%';
        document.getElementById('mb-stats').textContent = total > 0 ? (done + '/' + total + '  ' + pct + '%') : 'No steps';
      }

      document.getElementById('mission-bar').addEventListener('click', function() {
        document.querySelectorAll('.feed-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelector('[data-tab="tasks"]').classList.add('active');
        activeTab = 'tasks';
        renderFeed();
      });

      function updateActivityStrip() {
        if (!data || !data.feed || !data.feed.length) return;
        var latest = data.feed[data.feed.length - 1];
        document.getElementById('strip-event').textContent = latest.narrative || (latest.agent + ' did something');
        document.getElementById('strip-time').textContent = relTime(latest.timestamp);
      }

      // Render all
      function render() {
        try { updateStatus(); } catch(e) { console.error('updateStatus:', e); }
        try { updateStats(); } catch(e) { console.error('updateStats:', e); }
        try { updateStage(); } catch(e) { console.error('updateStage:', e); }
        try { renderAgents(); } catch(e) { console.error('renderAgents:', e); }
        try { renderFeed(); } catch(e) { console.error('renderFeed:', e); }
        try { updateMissionBar(); } catch(e) { console.error('updateMissionBar:', e); }
        try { updateActivityStrip(); } catch(e) { console.error('updateActivityStrip:', e); }
      }

      // Load data
      function loadData() {
        var old = document.getElementById('mc-data-script');
        if (old) old.remove();
        var s = document.createElement('script');
        s.id = 'mc-data-script';
        s.src = 'data.js?t=' + Date.now();
        s.onload = function() {
          if (typeof MC_DATA !== 'undefined') { data = MC_DATA; render(); }
        };
        s.onerror = function() {
          document.getElementById('status-dot').className = 'status-dot offline';
          document.getElementById('status-label').textContent = 'data.js error';
        };
        document.head.appendChild(s);
      }

      loadData();
      setInterval(loadData, 30000);

      document.addEventListener('keydown', function(e) {
        if (e.key === '1') document.querySelector('[data-tab="live"]').click();
        else if (e.key === '2') document.querySelector('[data-tab="tasks"]').click();
        else if (e.key === '3') document.querySelector('[data-tab="social"]').click();
      });

      // ── Office Animation System ──
      (function() {
        var svg = document.getElementById('stage-svg');
        if (!svg) return;

        // Agent state: 'desk' | 'lounge' | 'transitioning'
        var agentState = {};
        Object.keys(AGENT_POS).forEach(function(id) { agentState[id] = 'desk'; });

        var LOUNGE_DOOR = { x: 660, y: 155 };
        var COFFEE_POS = { x: 1050, y: 100 };
        var LOUNGE_SEATS = [
          { x: 922, y: 155, occupant: null },
          { x: 901, y: 191, occupant: null },
          { x: 859, y: 191, occupant: null },
          { x: 838, y: 155, occupant: null },
          { x: 859, y: 119, occupant: null },
          { x: 901, y: 119, occupant: null }
        ];

        function lerp(a, b, t) { return a + (b - a) * t; }
        function cubicEaseInOut(t) {
          return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function createWalker(agentId) {
          var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.setAttribute('id', 'walker-' + agentId);
          var isLead = agentId === 'krishna';
          var headR = isLead ? 6 : 5;
          var bodyW = isLead ? 12 : 10;
          var bodyH = isLead ? 10 : 8;
          var fill = isLead ? '#222' : '#444';
          var bodyFill = isLead ? '#333' : '#555';

          var head = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          head.setAttribute('cx', '0');
          head.setAttribute('cy', String(-bodyH / 2 - headR));
          head.setAttribute('r', String(headR));
          head.setAttribute('fill', fill);

          var body = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          body.setAttribute('x', String(-bodyW / 2));
          body.setAttribute('y', String(-bodyH / 2));
          body.setAttribute('width', String(bodyW));
          body.setAttribute('height', String(bodyH));
          body.setAttribute('rx', '2');
          body.setAttribute('fill', bodyFill);

          var legL = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          legL.setAttribute('x', '-3'); legL.setAttribute('y', String(bodyH / 2));
          legL.setAttribute('width', '2'); legL.setAttribute('height', '6');
          legL.setAttribute('fill', bodyFill); legL.classList.add('leg-l');

          var legR = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          legR.setAttribute('x', '1'); legR.setAttribute('y', String(bodyH / 2));
          legR.setAttribute('width', '2'); legR.setAttribute('height', '6');
          legR.setAttribute('fill', bodyFill); legR.classList.add('leg-r');

          g.appendChild(head);
          g.appendChild(body);
          g.appendChild(legL);
          g.appendChild(legR);
          return g;
        }

        // 2D walk animation between two points
        function animateWalk2D(walker, fromX, fromY, toX, toY, duration, onDone) {
          var start = performance.now();
          var legL = walker.querySelector('.leg-l');
          var legR = walker.querySelector('.leg-r');

          function tick(now) {
            var elapsed = now - start;
            var t = Math.min(elapsed / duration, 1);
            var et = cubicEaseInOut(t);
            var x = lerp(fromX, toX, et);
            var y = lerp(fromY, toY, et);
            var bobY = Math.sin(t * Math.PI * 10) * 1.5;
            walker.setAttribute('transform', 'translate(' + x + ',' + (y + bobY) + ')');

            if (legL && legR && t < 1) {
              var legSwing = Math.sin(elapsed / 70) * 4;
              legL.setAttribute('transform', 'rotate(' + legSwing + ',0,' + legL.getAttribute('y') + ')');
              legR.setAttribute('transform', 'rotate(' + (-legSwing) + ',0,' + legR.getAttribute('y') + ')');
            } else if (legL && legR) {
              legL.setAttribute('transform', '');
              legR.setAttribute('transform', '');
            }

            if (t < 1) requestAnimationFrame(tick);
            else if (onDone) onDone();
          }
          requestAnimationFrame(tick);
        }

        // Multi-waypoint walk: [{x,y}, ...] at ~120px/sec
        function animateWalkPath(walker, waypoints, onDone) {
          var segIndex = 0;
          function walkNext() {
            if (segIndex >= waypoints.length - 1) { if (onDone) onDone(); return; }
            var from = waypoints[segIndex];
            var to = waypoints[segIndex + 1];
            var dist = Math.sqrt(Math.pow(to.x - from.x, 2) + Math.pow(to.y - from.y, 2));
            var duration = Math.max(800, Math.min(5000, (dist / 120) * 1000));
            animateWalk2D(walker, from.x, from.y, to.x, to.y, duration, function() {
              segIndex++;
              walkNext();
            });
          }
          walkNext();
        }

        // Scene bubble (compact, matches data bubbles)
        function showSceneBubble(x, anchorY, text, duration) {
          var bubblesG = document.getElementById('stage-bubbles');
          if (!bubblesG) return;
          var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.classList.add('scene-bubble');
          g.setAttribute('filter', 'url(#bubble-shadow)');

          var displayText = text.length > 24 ? text.substring(0, 21) + '...' : text;
          var tw = Math.min(displayText.length * 5.5 + 16, 150);
          var bx = x - tw / 2;
          var bh = 22;
          var by = anchorY - bh - 6;

          var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', String(bx)); rect.setAttribute('y', String(by));
          rect.setAttribute('width', String(tw)); rect.setAttribute('height', String(bh));
          rect.setAttribute('rx', '6'); rect.setAttribute('fill', '#fff');
          rect.setAttribute('stroke', '#ccc'); rect.setAttribute('stroke-width', '0.5');

          var tri = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          tri.setAttribute('points', (x - 4) + ',' + (by + bh) + ' ' + x + ',' + (by + bh + 6) + ' ' + (x + 4) + ',' + (by + bh));
          tri.setAttribute('fill', '#fff'); tri.setAttribute('stroke', '#ccc'); tri.setAttribute('stroke-width', '0.5');

          var cover = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          cover.setAttribute('x1', String(x - 5)); cover.setAttribute('y1', String(by + bh));
          cover.setAttribute('x2', String(x + 5)); cover.setAttribute('y2', String(by + bh));
          cover.setAttribute('stroke', '#fff'); cover.setAttribute('stroke-width', '1');

          var txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          txt.setAttribute('x', String(x)); txt.setAttribute('y', String(by + 15));
          txt.setAttribute('font-size', '9'); txt.setAttribute('fill', '#333');
          txt.setAttribute('text-anchor', 'middle');
          txt.setAttribute('font-family', '-apple-system, sans-serif');
          txt.setAttribute('font-style', 'italic');
          txt.textContent = displayText;

          g.appendChild(rect); g.appendChild(tri); g.appendChild(cover); g.appendChild(txt);
          bubblesG.appendChild(g);
          setTimeout(function() { if (g.parentNode) g.parentNode.removeChild(g); }, duration);
        }

        function setPersonVisible(agentId, visible) {
          var station = document.getElementById('station-' + agentId);
          if (!station) return;
          var circles = station.querySelectorAll('circle[fill="#444"], circle[fill="#222"], circle[fill="#111"]');
          var rects = station.querySelectorAll('rect[fill="#555"], rect[fill="#333"]');
          var opacity = visible ? '1' : '0.15';
          circles.forEach(function(el) { el.style.opacity = opacity; });
          rects.forEach(function(el) {
            var w = parseInt(el.getAttribute('width'));
            if (w <= 12) el.style.opacity = opacity;
          });
          if (agentId === 'krishna') {
            var crown = station.querySelector('polygon');
            if (crown) crown.style.opacity = opacity;
          }
        }

        // Sitting figure in lounge
        function showSittingFigure(agentId, seatIdx) {
          var seat = LOUNGE_SEATS[seatIdx];
          var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.setAttribute('id', 'sitting-' + agentId);
          var isLead = agentId === 'krishna';
          var headR = isLead ? 4 : 3.5;
          var fill = isLead ? '#222' : '#444';

          var head = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          head.setAttribute('cx', String(seat.x));
          head.setAttribute('cy', String(seat.y - 6));
          head.setAttribute('r', String(headR));
          head.setAttribute('fill', fill);

          var body = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          body.setAttribute('x', String(seat.x - 4));
          body.setAttribute('y', String(seat.y - 2));
          body.setAttribute('width', '8'); body.setAttribute('height', '6');
          body.setAttribute('rx', '2');
          body.setAttribute('fill', isLead ? '#333' : '#555');

          var sway = document.createElementNS('http://www.w3.org/2000/svg', 'animateTransform');
          sway.setAttribute('attributeName', 'transform');
          sway.setAttribute('type', 'translate');
          sway.setAttribute('values', '0,0;0.2,-0.3;0,0;-0.2,-0.2;0,0');
          sway.setAttribute('dur', '6s');
          sway.setAttribute('repeatCount', 'indefinite');

          g.appendChild(sway);
          g.appendChild(head);
          g.appendChild(body);
          var loungeG = document.getElementById('stage-lounge-figures');
          if (loungeG) loungeG.appendChild(g);
          else svg.appendChild(g);
        }

        function removeSittingFigure(agentId) {
          var el = document.getElementById('sitting-' + agentId);
          if (el && el.parentNode) el.parentNode.removeChild(el);
        }

        // Visit with 25px offset + cross-row waypoints
        function playVisit(fromId, toId, bubble, onDone) {
          var from = AGENT_POS[fromId];
          var to = AGENT_POS[toId];
          if (!from || !to || agentState[fromId] !== 'desk' || agentState[toId] !== 'desk') {
            onDone(); return;
          }
          agentState[fromId] = 'transitioning';

          var walker = createWalker(fromId);
          svg.appendChild(walker);
          walker.setAttribute('transform', 'translate(' + from.x + ',' + from.y + ')');
          setPersonVisible(fromId, false);

          var approachX = to.x + (from.x < to.x ? -25 : 25);
          var waypoints = [{ x: from.x, y: from.y }];
          if (from.row !== to.row) {
            var aisleX = 570;
            waypoints.push({ x: aisleX, y: from.y });
            waypoints.push({ x: aisleX, y: to.y });
          }
          waypoints.push({ x: approachX, y: to.y });

          animateWalkPath(walker, waypoints, function() {
            showSceneBubble(to.x, to.y - 25, bubble, 3000);
            setTimeout(function() {
              var retWp = waypoints.slice().reverse();
              retWp[0] = { x: approachX, y: to.y };
              retWp[retWp.length - 1] = { x: from.x, y: from.y };
              animateWalkPath(walker, retWp, function() {
                setPersonVisible(fromId, true);
                if (walker.parentNode) walker.parentNode.removeChild(walker);
                agentState[fromId] = 'desk';
                onDone();
              });
            }, 3500);
          });
        }

        // Huddle: agents gather in desk area center
        function playHuddle(agentIds, bubble, onDone) {
          var centerX = 300, centerY = 155;
          var validAgents = agentIds.filter(function(id) { return agentState[id] === 'desk'; });
          if (validAgents.length < 2) { onDone(); return; }

          var walkers = [];
          var completed = 0;
          var total = validAgents.length;

          validAgents.forEach(function(id, i) {
            var from = AGENT_POS[id];
            agentState[id] = 'transitioning';
            var walker = createWalker(id);
            svg.appendChild(walker);
            walker.setAttribute('transform', 'translate(' + from.x + ',' + from.y + ')');
            setPersonVisible(id, false);

            var spread = (i - (total - 1) / 2) * 20;
            var targetX = centerX + spread;
            var wp = [{ x: from.x, y: from.y }];
            if (from.y !== centerY) wp.push({ x: from.x, y: centerY });
            wp.push({ x: targetX, y: centerY });

            walkers.push({ id: id, walker: walker, fromX: from.x, fromY: from.y, targetX: targetX });

            animateWalkPath(walker, wp, function() {
              completed++;
              if (completed === total) {
                showSceneBubble(centerX, centerY - 25, bubble, 3500);
                var dots = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                dots.setAttribute('x', String(centerX));
                dots.setAttribute('y', String(centerY + 25));
                dots.setAttribute('text-anchor', 'middle');
                dots.setAttribute('font-size', '10');
                dots.setAttribute('fill', '#999');
                dots.textContent = '\u2022 \u2022 \u2022';
                svg.appendChild(dots);

                setTimeout(function() {
                  if (dots.parentNode) dots.parentNode.removeChild(dots);
                  var backDone = 0;
                  walkers.forEach(function(w) {
                    var retWp = [{ x: w.targetX, y: centerY }];
                    if (w.fromY !== centerY) retWp.push({ x: w.fromX, y: centerY });
                    retWp.push({ x: w.fromX, y: w.fromY });
                    animateWalkPath(w.walker, retWp, function() {
                      setPersonVisible(w.id, true);
                      if (w.walker.parentNode) w.walker.parentNode.removeChild(w.walker);
                      agentState[w.id] = 'desk';
                      backDone++;
                      if (backDone === walkers.length) onDone();
                    });
                  });
                }, 4000);
              }
            });
          });
        }

        // Coffee: walk to lounge coffee machine
        function playCoffee(agentId, onDone) {
          var from = AGENT_POS[agentId];
          if (!from || agentState[agentId] !== 'desk') { onDone(); return; }
          agentState[agentId] = 'transitioning';

          var walker = createWalker(agentId);
          svg.appendChild(walker);
          walker.setAttribute('transform', 'translate(' + from.x + ',' + from.y + ')');
          setPersonVisible(agentId, false);

          var wp = [
            { x: from.x, y: from.y },
            { x: 570, y: from.y },
            { x: 570, y: LOUNGE_DOOR.y },
            { x: LOUNGE_DOOR.x, y: LOUNGE_DOOR.y },
            { x: COFFEE_POS.x, y: COFFEE_POS.y }
          ];

          animateWalkPath(walker, wp, function() {
            showSceneBubble(COFFEE_POS.x, COFFEE_POS.y - 20, 'Coffee break...', 2500);
            setTimeout(function() {
              animateWalkPath(walker, wp.slice().reverse(), function() {
                setPersonVisible(agentId, true);
                if (walker.parentNode) walker.parentNode.removeChild(walker);
                agentState[agentId] = 'desk';
                onDone();
              });
            }, 3000);
          });
        }

        // Lounge enter: walk from desk to a seat
        function playLoungeEnter(agentId, onDone) {
          var from = AGENT_POS[agentId];
          if (!from || agentState[agentId] !== 'desk') { onDone(); return; }

          var seatIdx = -1;
          for (var i = 0; i < LOUNGE_SEATS.length; i++) {
            if (!LOUNGE_SEATS[i].occupant) { seatIdx = i; break; }
          }
          if (seatIdx === -1) { onDone(); return; }

          agentState[agentId] = 'transitioning';
          LOUNGE_SEATS[seatIdx].occupant = agentId;

          var walker = createWalker(agentId);
          svg.appendChild(walker);
          walker.setAttribute('transform', 'translate(' + from.x + ',' + from.y + ')');
          setPersonVisible(agentId, false);

          var seat = LOUNGE_SEATS[seatIdx];
          var wp = [
            { x: from.x, y: from.y },
            { x: 570, y: from.y },
            { x: 570, y: LOUNGE_DOOR.y },
            { x: LOUNGE_DOOR.x, y: LOUNGE_DOOR.y },
            { x: seat.x, y: seat.y }
          ];

          animateWalkPath(walker, wp, function() {
            if (walker.parentNode) walker.parentNode.removeChild(walker);
            showSittingFigure(agentId, seatIdx);
            agentState[agentId] = 'lounge';
            showSceneBubble(seat.x, seat.y - 15, 'Taking a break...', 2500);
            onDone();
          });
        }

        // Lounge exit: walk from seat back to desk
        function playLoungeExit(agentId, onDone) {
          var pos = AGENT_POS[agentId];
          if (!pos || agentState[agentId] !== 'lounge') { onDone(); return; }

          var seatIdx = -1;
          for (var i = 0; i < LOUNGE_SEATS.length; i++) {
            if (LOUNGE_SEATS[i].occupant === agentId) { seatIdx = i; break; }
          }
          if (seatIdx === -1) { onDone(); return; }

          agentState[agentId] = 'transitioning';
          var seat = LOUNGE_SEATS[seatIdx];
          removeSittingFigure(agentId);

          var walker = createWalker(agentId);
          svg.appendChild(walker);
          walker.setAttribute('transform', 'translate(' + seat.x + ',' + seat.y + ')');

          var wp = [
            { x: seat.x, y: seat.y },
            { x: LOUNGE_DOOR.x, y: LOUNGE_DOOR.y },
            { x: 570, y: LOUNGE_DOOR.y },
            { x: 570, y: pos.y },
            { x: pos.x, y: pos.y }
          ];

          animateWalkPath(walker, wp, function() {
            if (walker.parentNode) walker.parentNode.removeChild(walker);
            setPersonVisible(agentId, true);
            LOUNGE_SEATS[seatIdx].occupant = null;
            agentState[agentId] = 'desk';
            showSceneBubble(pos.x, pos.y - 25, 'Back to work', 2000);
            onDone();
          });
        }

        // Expanded scene rotation (~19 scenes)
        var scenes = [
          { type: 'visit', from: 'krishna', to: 'hanuman', bubble: 'How\'s the security scan?' },
          { type: 'lounge_enter', agent: 'narada' },
          { type: 'visit', from: 'krishna', to: 'vishwa', bubble: 'Ship the new feature?' },
          { type: 'coffee', agent: 'vidura' },
          { type: 'lounge_enter', agent: 'chanakya' },
          { type: 'huddle', agents: ['krishna', 'vishwa', 'hanuman'], bubble: 'Quick standup...' },
          { type: 'lounge_exit', agent: 'narada' },
          { type: 'lounge_exit', agent: 'chanakya' },
          { type: 'visit', from: 'krishna', to: 'narada', bubble: 'Got the research ready?' },
          { type: 'coffee', agent: 'hanuman' },
          { type: 'visit', from: 'krishna', to: 'chanakya', bubble: 'Growth metrics looking good?' },
          { type: 'lounge_enter', agent: 'vidura' },
          { type: 'visit', from: 'narada', to: 'vishwa', bubble: 'Found something interesting' },
          { type: 'lounge_exit', agent: 'vidura' },
          { type: 'huddle', agents: ['krishna', 'chanakya', 'narada', 'vidura'], bubble: 'Architecture review...' },
          { type: 'coffee', agent: 'narada' },
          { type: 'visit', from: 'hanuman', to: 'chanakya', bubble: 'Security audit results' },
          { type: 'lounge_enter', agent: 'vishwa' },
          { type: 'lounge_exit', agent: 'vishwa' }
        ];
        var sceneIndex = 0;
        var sceneActive = false;

        function playNextScene() {
          if (sceneActive) return;
          sceneActive = true;
          var scene = scenes[sceneIndex % scenes.length];
          sceneIndex++;

          var onDone = function() {
            sceneActive = false;
            var pause = 6000 + Math.random() * 6000;
            setTimeout(playNextScene, pause);
          };

          if (scene.type === 'visit') {
            playVisit(scene.from, scene.to, scene.bubble, onDone);
          } else if (scene.type === 'huddle') {
            playHuddle(scene.agents, scene.bubble, onDone);
          } else if (scene.type === 'coffee') {
            playCoffee(scene.agent, onDone);
          } else if (scene.type === 'lounge_enter') {
            playLoungeEnter(scene.agent, onDone);
          } else if (scene.type === 'lounge_exit') {
            playLoungeExit(scene.agent, onDone);
          } else {
            onDone();
          }
        }

        setTimeout(playNextScene, 5000);
      })();

    })();
  </script>
<script>
document.querySelector('.nav__toggle').addEventListener('click', function() {
  document.querySelector('.nav__links').classList.toggle('open');
});
// Close menu when clicking a link
document.querySelectorAll('.nav__links a').forEach(function(a) {
  a.addEventListener('click', function() { document.querySelector('.nav__links').classList.remove('open'); });
});
</script>
</body>
</html>
